<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç™¾äººä¸€é¦– 4æŠã‚²ãƒ¼ãƒ ï¼ˆæ©™æœ­20é¦–â†’10å•ï¼å¾©ç¿’ãƒ»èª­ã¿ä¸Šã’ãƒ»å’Œé¢¨æ¼”å‡ºï¼‰</title>
  <style>
    :root{
      --ink:#1a1a1a;

      /* å’Œé¢¨ãƒãƒƒãƒ—é…è‰² */
      --aka:#e53935;     /* æœ± */
      --beni:#ff4f7b;    /* ç´… */
      --ai:#1e5aa8;      /* è— */
      --wakakusa:#2e9b6d;/* è‹¥è‰ */
      --fuji:#7b4ae2;    /* è—¤ */
      --kin:#d6b25e;     /* é‡‘ */
      --washi:#fbf6ea;   /* å’Œç´™ */
      --washi2:#f7efe0;

      --card: rgba(255,255,255,.80);
      --shadow: 0 14px 30px rgba(0,0,0,.14);
      --border: rgba(0,0,0,.08);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      color:var(--ink);
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      background:
        radial-gradient(900px 520px at 18% 12%, rgba(214,178,94,.22), transparent 58%),
        radial-gradient(760px 520px at 88% 18%, rgba(214,178,94,.15), transparent 60%),
        radial-gradient(900px 700px at 55% 105%, rgba(255,79,123,.10), transparent 60%),
        radial-gradient(800px 600px at 10% 85%, rgba(30,90,168,.10), transparent 60%),
        linear-gradient(180deg, var(--washi), var(--washi2));
      position: relative;
    }

    /* ã•ã‚Šã’ãªã„éº»ã®è‘‰é¢¨ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆè–„ãï¼‰ */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.10;
      background:
        linear-gradient(30deg, rgba(0,0,0,.18) 12%, transparent 12.5%, transparent 87%, rgba(0,0,0,.18) 87.5%, rgba(0,0,0,.18)),
        linear-gradient(150deg, rgba(0,0,0,.18) 12%, transparent 12.5%, transparent 87%, rgba(0,0,0,.18) 87.5%, rgba(0,0,0,.18)),
        linear-gradient(90deg, rgba(0,0,0,.18) 2%, transparent 2.5%, transparent 97%, rgba(0,0,0,.18) 97.5%, rgba(0,0,0,.18));
      background-size: 56px 56px;
      mix-blend-mode: multiply;
    }

    .wrap{ max-width: 920px; margin: 0 auto; padding: 18px; }

    /* ã‚«ãƒ¼ãƒ‰ï¼ˆå’Œç´™ï¼‹é‡‘ç¸ï¼‰ */
    .card{
      background: var(--card);
      border-radius: 18px;
      padding: 16px;
      margin-bottom: 14px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(214,178,94,.55);
      position:relative;
      overflow:hidden;
    }
    .card::after{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(480px 180px at 20% 0%, rgba(214,178,94,.25), transparent 60%),
        radial-gradient(520px 200px at 90% 10%, rgba(214,178,94,.18), transparent 60%);
      pointer-events:none;
    }

    h1{
      font-size: 18px;
      margin: 0 0 10px;
      display:flex;
      align-items:center;
      gap:10px;
      letter-spacing:.02em;
      position:relative;
    }
    h1::before{
      content:"ğŸŒ¸ğŸ´";
      font-size: 20px;
    }
    .meta{ color:#3a3a3a; font-size: 13px; line-height:1.6; position:relative; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; position:relative; }

    button{
      border:0;
      border-radius: 14px;
      padding: 11px 14px;
      cursor:pointer;
      font-weight: 800;
      letter-spacing:.02em;
      transition: transform .08s ease, filter .12s ease, box-shadow .12s ease;
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
      position:relative;
      z-index:1;
    }
    button:active{ transform: translateY(1px) scale(.99); }
    button:disabled{ opacity:.45; cursor:not-allowed; box-shadow:none; }

    #btnStart{ background: linear-gradient(135deg, var(--aka), var(--beni)); color:#fff; }
    #btnNextGame{ background: linear-gradient(135deg, var(--ai), #2f80ed); color:#fff; }
    #btnReview{ background: linear-gradient(135deg, var(--wakakusa), #3cc48a); color:#fff; }
    #btnSpeak, button.secondary{
      background: linear-gradient(135deg, rgba(255,255,255,.92), rgba(255,255,255,.68));
      color:#222;
      border: 1px solid var(--border);
    }

    .pill{
      background: linear-gradient(135deg, rgba(255,255,255,.95), rgba(255,255,255,.65));
      border:1px solid rgba(214,178,94,.45);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color:#222;
      position:relative;
      z-index:1;
    }

    /* ä¸Šã®å¥ï¼šçŸ­å†Šã£ã½ã */
    .kami{
      font-size: 26px;
      line-height: 1.58;
      margin: 10px 0 0;
      padding: 14px 14px;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.88), rgba(255,255,255,.60));
      border: 1px solid rgba(214,178,94,.45);
      position:relative;
      overflow:hidden;
    }
    .kami::before{
      content:"";
      position:absolute;
      left:12px;
      right:12px;
      top:10px;
      height:2px;
      background: linear-gradient(90deg, transparent, rgba(214,178,94,.9), transparent);
      opacity:.8;
    }
    .kami::after{
      content:"";
      position:absolute;
      left:12px;
      right:12px;
      bottom:10px;
      height:2px;
      background: linear-gradient(90deg, transparent, rgba(214,178,94,.7), transparent);
      opacity:.7;
    }

    #choices{ display:grid; gap:10px; }

    button.choice{
      width:100%;
      text-align:left;
      padding: 14px 14px;
      background: linear-gradient(135deg, rgba(255,255,255,.92), rgba(255,255,255,.66));
      color:#111;
      font-weight: 800;
      border:1px solid rgba(0,0,0,.07);
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
    }
    button.choice:nth-child(1){ border-left: 10px solid var(--beni); }
    button.choice:nth-child(2){ border-left: 10px solid var(--aka); }
    button.choice:nth-child(3){ border-left: 10px solid var(--ai); }
    button.choice:nth-child(4){ border-left: 10px solid var(--fuji); }
    button.choice:hover{ filter: brightness(1.03); }

    .result{
      font-size: 16px;
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      border:1px solid rgba(0,0,0,.06);
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
    }
    .ok{
      background: linear-gradient(135deg, rgba(46,155,109,.18), rgba(255,255,255,.82));
      border-color: rgba(46,155,109,.25);
    }
    .ng{
      background: linear-gradient(135deg, rgba(255,79,123,.20), rgba(255,255,255,.82));
      border-color: rgba(255,79,123,.25);
    }

    .footer{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    /* é–“é•ã„æœ­ãƒªã‚¹ãƒˆã‚‚å’Œç´™ã£ã½ã */
    #missList .result.ng{ border: 1px solid rgba(255,79,123,.28); }
    #missList > div[style*="border-radius"]{
      background: linear-gradient(135deg, rgba(255,255,255,.92), rgba(255,255,255,.70)) !important;
      border: 1px solid rgba(214,178,94,.35) !important;
    }

    @media (max-width: 520px){
      .kami{ font-size: 22px; }
      button{ width:100%; }
      .row{ gap:8px; }
    }

    /* ===== å’Œé¢¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆæ­£è§£ï¼šé‡‘ç²‰ï¼ä¸æ­£è§£ï¼šæš—ããªã‚‹ï¼‰ ===== */
    .effect-layer{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
      overflow: hidden;
    }
    .confetti{
      position: absolute;
      width: 10px;
      height: 10px;
      opacity: .95;
      animation: fall 900ms ease-out forwards;
    }
    .confetti.ok{
      background: radial-gradient(circle at 30% 30%, #fff7cc, #d6b25e);
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(214,178,94,.9);
    }
    .confetti.ng{
      background: linear-gradient(135deg, #ff9db6, #ff4f7b);
      border-radius: 70% 30% 70% 30%;
    }
    @keyframes fall{
      0%{ transform: translateY(-10px) rotate(0deg) scale(1); opacity: 1; }
      100%{ transform: translateY(120vh) rotate(240deg) scale(.9); opacity: 0; }
    }
/* ===== ã‚¹ãƒãƒ›ã§ã€Œæ­£è§£/ä¸æ­£è§£ã€ã‚’å¿…ãšè¦‹ãˆã‚‹ä½ç½®ã«å›ºå®š ===== */
@media (max-width: 520px){

  /* ä¸‹ã«å›ºå®šã™ã‚‹çµæœæ¬„ã®åˆ†ã ã‘ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å´ã«ä½™ç™½ã‚’ç¢ºä¿ */
  .wrap{ padding-bottom: 140px; }

  /* çµæœè¡¨ç¤ºã‚’ç”»é¢ä¸‹ã«å›ºå®š */
  #result{
    position: fixed;
    left: 12px;
    right: 12px;
    bottom: 12px;
    z-index: 9998;
    margin: 0;
  }

  /* ä¸­èº«ã‚’å°‘ã—ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
  #result .result{
    margin-top: 0;
    padding: 10px 12px;
    font-size: 14px;
    border-radius: 14px;
  }
}

  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ç™¾äººä¸€é¦– 4æŠã‚²ãƒ¼ãƒ ï¼ˆæ©™æœ­20é¦–â†’10å•ï¼å¾©ç¿’ãƒ»èª­ã¿ä¸Šã’ãƒ»å’Œé¢¨æ¼”å‡ºï¼‰</h1>
      <div class="row">
        <button id="btnStart">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="btnNextGame" class="secondary" disabled>æ¬¡ã«é€²ã‚€ï¼ˆæ¬¡ã®10å•ï¼‰</button>
        <button id="btnReview" class="secondary" disabled>é–“é•ãˆãŸæœ­ã ã‘å¾©ç¿’</button>
        <button id="btnSpeak" class="secondary" disabled>ä¸Šã®å¥ã‚’èª­ã¿ä¸Šã’</button>
        <span class="pill" id="voiceStatus">éŸ³å£°ï¼šæœªç¢ºèª</span>
      </div>
      <p class="meta">
        ãƒ»å¯¾è±¡ï¼šäº”è‰²ç™¾äººä¸€é¦– æ©™æœ­ã€€20é¦–ï¼1ã‚²ãƒ¼ãƒ 10å•<br>
        ãƒ»ä¸æ­£è§£ã®ã¨ãã ã‘ã€Œæ­£ã—ã„ä¸‹ã®å¥ã€ã‚’èª­ã¿ä¸Šã’ã¾ã™<br>
        ãƒ»ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã«ã€Œé–“é•ãˆãŸæœ­ä¸€è¦§ã€ã‚’è¡¨ç¤ºã—ã¾ã™<br>
      </p>
    </div>

    <div class="card">
      <div class="footer">
        <div class="meta" id="progress">æœªé–‹å§‹</div>
        <div class="meta" id="score">ã‚¹ã‚³ã‚¢ï¼š0 / 0</div>
      </div>

      <div class="kami" id="kami">ã€Œã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>

      <div style="margin-top:12px" id="choices"></div>
      <div id="result"></div>
      <div id="missList" style="margin-top:12px"></div>
    </div>
  </div>

  <div class="effect-layer" id="effectLayer"></div>

<script>
/**
 * äº”è‰²ç™¾äººä¸€é¦– æ©™æœ­ã€€20é¦–
 * format:
 * { id: 1, kami: "ä¸Šã®å¥", shimo: "ä¸‹ã®å¥" }
 */
const POEMS = [
  {
    id: 1,
    kami: "æ˜ã‘ã¬ã‚Œã° æš®ã‚‹ã‚‹ã‚‚ã®ã¨ã¯ çŸ¥ã‚ŠãªãŒã‚‰",
    shimo: "ãªã»æ¨ã‚ã—ã æœã¼ã‚‰ã‘ã‹ãª",
    kamiRead: "ã‚ã‘ã¬ã‚Œã° ãã‚‹ã‚‹ã‚‚ã®ã¨ã¯ ã—ã‚ŠãªãŒã‚‰",
    shimoRead: "ãªãŠã†ã‚‰ã‚ã—ã ã‚ã•ã¼ã‚‰ã‘ã‹ãª",
  },
  {
    id: 2,
    kami: "æœã¼ã‚‰ã‘ å®‡æ²»ã®å·éœ§ ãŸãˆã ãˆã«",
    shimo: "ã‚ã‚‰ã¯ã‚Œã‚ãŸã‚‹ ç€¬ã€…ã®ç¶²ä»£æœ¨",
    kamiRead: "ã‚ã•ã¼ã‚‰ã‘ ã†ã˜ã®ã‹ã‚ãã‚Š ãŸãˆã ãˆã«",
    shimoRead: "ã‚ã‚‰ã‚ã‚Œã‚ãŸã‚‹ ã›ãœã®ã‚ã˜ã‚ã",
  },
  {
    id: 3,
    kami: "ã‚ã¯ã‚Œã¨ã‚‚ è¨€ãµã¹ãäººã¯ æ€ã»ãˆã§",
    shimo: "èº«ã®ã„ãŸã¥ã‚‰ã« ãªã‚Šã¬ã¹ãã‹ãª",
    kamiRead: "ã‚ã‚ã‚Œã¨ã‚‚ ã„ã†ã¹ãã²ã¨ã¯ ãŠã‚‚ãŠãˆã§",
    shimoRead: "ã¿ã®ã„ãŸãšã‚‰ã« ãªã‚Šã¬ã¹ãã‹ãª",
  },
  {
    id: 4,
    kami: "é€¢ã²è¦‹ã¦ã® ã®ã¡ã®å¿ƒã« æ¯”ã¶ã‚Œã°",
    shimo: "æ˜”ã¯ç‰©ã‚’ æ€ã¯ã–ã‚Šã‘ã‚Š",
    kamiRead: "ã‚ã„ã¿ã¦ã® ã®ã¡ã®ã“ã“ã‚ã« ãã‚‰ã¶ã‚Œã°",
    shimoRead: "ã‚€ã‹ã—ã¯ã€€ã‚‚ã®ã‚’ ãŠã‚‚ã‚ã–ã‚Šã‘ã‚Š",
  },
  {
    id: 5,
    kami: "é€¢ãµã“ã¨ã® çµ¶ãˆã¦ã—ãªãã¯ ãªã‹ãªã‹ã«",
    shimo: "äººã‚’ã‚‚èº«ã‚’ã‚‚ æ¨ã¿ã–ã‚‰ã¾ã—",
    kamiRead: "ã‚ã†ã“ã¨ã® ãŸãˆã¦ã—ãªãã¯ ãªã‹ãªã‹ã«",
    shimoRead: "ã²ã¨ã‚’ã‚‚ã¿ã‚’ã‚‚ ã†ã‚‰ã¿ã–ã‚‰ã¾ã—",
  },
  {
    id: 6,
    kami: "ã‚ã‚‰ã–ã‚‰ã‚€ ã“ã®ä¸–ã®ã»ã‹ã® æ€ã²å‡ºã«",
    shimo: "ä»Šã²ã¨ãŸã³ã® é€¢ãµã“ã¨ã‚‚ãŒãª",
    kamiRead: "ã‚ã‚‰ã–ã‚‰ã‚“ ã“ã®ã‚ˆã®ã»ã‹ã® ãŠã‚‚ã„ã„ã§ã«",
    shimoRead: "ã„ã¾ã²ã¨ãŸã³ã® ã‚ã†ã“ã¨ã‚‚ãŒãª",
  },
  {
    id: 7,
    kami: "ä»Šæ¥ã‚€ã¨ è¨€ã²ã—ã°ã‹ã‚Šã« é•·æœˆã®",
    shimo: "æœ‰æ˜ã®æœˆã‚’ å¾…ã¡å‡ºã§ã¤ã‚‹ã‹ãª",
    kamiRead: "ã„ã¾ã“ã‚“ã¨ ã„ã„ã—ã°ã‹ã‚Šã« ãªãŒã¤ãã®",
    shimoRead: "ã‚ã‚Šã‚ã‘ã®ã¤ãã‚’ ã¾ã¡ã„ã§ã¤ã‚‹ã‹ãª",
  },
  {
    id: 8,
    kami: "ä»Šã¯ãŸã  æ€ã²çµ¶ãˆãªã‚€ ã¨ã°ã‹ã‚Šã‚’",
    shimo: "äººã¥ã¦ãªã‚‰ã§ è¨€ãµã‚ˆã—ã‚‚ãŒãª",
    kamiRead: "ã„ã¾ã‚ãŸã  ãŠã‚‚ã„ãŸãˆãªã‚“ ã¨ã°ã‹ã‚Šã‚’",
    shimoRead: "ã²ã¨ã¥ã¦ãªã‚‰ã§ ã‚†ã†ã‚ˆã—ã‚‚ãŒãª",
  },
  {
    id: 9,
    kami: "ç€¬ã‚’æ—©ã¿ å²©ã«ã›ã‹ã‚‹ã‚‹ æ»å·ã®",
    shimo: "ã‚ã‚Œã¦ã‚‚æœ«ã« é€¢ã¯ã‚€ã¨ãæ€ãµ",
    kamiRead: "ã›ã‚’ã¯ã‚„ã¿ ã„ã‚ã«ã›ã‹ã‚‹ã‚‹ ãŸããŒã‚ã®",
    shimoRead: "ã‚ã‚Œã¦ã‚‚ã™ãˆã« ã‚ã‚ã‚“ã¨ããŠã‚‚ã†",
  },
  {
    id: 10,
    kami: "å˜†ãã¤ã¤ ã²ã¨ã‚Šå¯ã‚‹ å¤œã®æ˜ãã‚‹é–“ã¯",
    shimo: "ã„ã‹ã«ä¹…ã—ã ã‚‚ã®ã¨ã‹ã¯çŸ¥ã‚‹",
    kamiRead: "ãªã’ãã¤ã¤ ã²ã¨ã‚Šã¬ã‚‹ ã‚ˆã®ã€€ã‚ãã‚‹ã¾ã¯",
    shimoRead: "ã„ã‹ã«ã²ã•ã—ã ã‚‚ã®ã¨ã‹ã‚ã€€ã—ã‚‹",
  },
  {
    id: 11,
    kami: "åã«ã—è² ã¯ã° é€¢å‚å±±ã® ã•ã­ã‹ã¥ã‚‰",
    shimo: "äººã«çŸ¥ã‚‰ã‚Œã§ æ¥ã‚‹ã‚ˆã—ã‚‚ãŒãª",
    kamiRead: "ãªã«ã—ãŠã‚ã° ãŠã†ã•ã‹ã‚„ã¾ã® ã•ã­ã‹ãšã‚‰",
    shimoRead: "ã²ã¨ã«ã—ã‚‰ã‚Œã§ ãã‚‹ã‚ˆã—ã‚‚ãŒãª",
  },
  {
    id: 12,
    kami: "é›£æ³¢æ±Ÿã® è‘¦ã®ã‹ã‚Šã­ã® ã²ã¨ã‚ˆã‚†ã‚‘",
    shimo: "ã¿ã‚’ã¤ãã—ã¦ã‚„ æ‹ã²ã‚ãŸã‚‹ã¹ã",
    kamiRead: "ãªã«ã‚ãˆã® ã‚ã—ã®ã‹ã‚Šã­ã® ã²ã¨ã‚ˆã‚†ãˆ",
    shimoRead: "ã¿ã‚’ã¤ãã—ã¦ã‚„ ã“ã„ã‚ãŸã‚‹ã¹ã",
  },
  {
    id: 13,
    kami: "é›£æ³¢æ½Ÿ çŸ­ãè‘¦ã® ãµã—ã®é–“ã‚‚",
    shimo: "é€¢ã¯ã§ã“ã®ä¸–ã‚’ éãã—ã¦ã‚ˆã¨ã‚„",
    kamiRead: "ãªã«ã‚ãŒãŸ ã¿ã˜ã‹ãã‚ã—ã® ãµã—ã®ã¾ã‚‚",
    shimoRead: "ã‚ã‚ã§ã“ã®ã‚ˆã‚’ ã™ãã—ã¦ã‚ˆã¨ã‚„",
  },
  {
    id: 14,
    kami: "æ˜¥ã®å¤œã® å¤¢ã°ã‹ã‚Šãªã‚‹ æ‰‹æ•ã«",
    shimo: "ã‹ã²ãªãç«‹ãŸã‚€ åã“ãæƒœã—ã‘ã‚Œ",
    kamiRead: "ã¯ã‚‹ã®ã‚ˆã® ã‚†ã‚ã°ã‹ã‚Šãªã‚‹ ãŸã¾ãã‚‰ã«",
    shimoRead: "ã‹ã„ãªããŸãŸã‚“ ãªã“ããŠã—ã‘ã‚Œ",
  },
  {
    id: 15,
    kami: "äººã‚‚ã‚’ã— äººã‚‚æ¨ã‚ã— ã‚ã¢ããªã",
    shimo: "ä¸–ã‚’æ€ãµã‚†ã‚‘ã« ç‰©æ€ãµèº«ã¯",
    kamiRead: "ã²ã¨ã‚‚ãŠã— ã²ã¨ã‚‚ã†ã‚‰ã‚ã— ã‚ã˜ããªã",
    shimoRead: "ã‚ˆã‚’ãŠã‚‚ã†ã‚†ãˆã« ã‚‚ã®ãŠã‚‚ã†ã¿ã¯",
  },
  {
    id: 16,
    kami: "å¾¡å£å®ˆ è¡›å£«ã®ç„šãç«ã® å¤œã¯ç‡ƒãˆ",
    shimo: "æ˜¼ã¯æ¶ˆãˆã¤ã¤ ç‰©ã‚’ã“ãæ€ã¸",
    kamiRead: "ã¿ã‹ãã‚‚ã‚Š ãˆã˜ã®ãŸãã²ã® ã‚ˆã‚‹ã¯ã‚‚ãˆ",
    shimoRead: "ã²ã‚‹ã¯ã€€ããˆã¤ã¤ ã‚‚ã®ã‚’ã“ããŠã‚‚ãˆ",
  },
  {
    id: 17,
    kami: "ã¿ã‹ã®åŸ ã‚ãã¦æµã‚‹ã‚‹ ã„ã¥ã¿å·",
    shimo: "ã„ã¤è¦‹ãã¨ã¦ã‹ æ‹ã—ã‹ã‚‹ã‚‰ã‚€",
    kamiRead: "ã¿ã‹ã®ã¯ã‚‰ ã‚ãã¦ãªãŒã‚‹ã‚‹ ã„ãšã¿ãŒã‚",
    shimoRead: "ã„ã¤ã¿ãã¨ã¦ã‹ ã“ã„ã—ã‹ã‚‹ã‚‰ã‚“",
  },
  {
    id: 18,
    kami: "è¦‹ã›ã°ã‚„ãª é›„å³¶ã®æµ·äººã® è¢–ã ã«ã‚‚",
    shimo: "æ¿¡ã‚Œã«ãæ¿¡ã‚Œã— è‰²ã¯å¤‰ã¯ã‚‰ãš",
    kamiRead: "ã¿ã›ã°ã‚„ãª ãŠã˜ã¾ã®ã‚ã¾ã® ãã§ã ã«ã‚‚",
    shimoRead: "ã¬ã‚Œã«ãã¬ã‚Œã— ã„ã‚ã‚ã€€ã‹ã‚ã‚‰ãš",
  },
  {
    id: 19,
    kami: "ãŠã»ã‘ãªã æ†‚ãä¸–ã®æ°‘ã« ãŠã»ãµã‹ãª",
    shimo: "ã‚ãŒç«‹ã¤æ£ã« å¢¨æŸ“ã®è¢–",
    kamiRead: "ãŠãŠã‘ãªã ã†ãã‚ˆã®ãŸã¿ã« ãŠãŠã†ã‹ãª",
    shimoRead: "ã‚ãŒãŸã¤ãã¾ã« ã™ã¿ãã‚ã®ãã§",
  },
  {
    id: 20,
    kami: "é¢¨ãã‚ˆã æ¥¢ã®å°å·ã® å¤•æš®ã¯",
    shimo: "ã¿ãããå¤ã® ã—ã‚‹ã—ãªã‚Šã‘ã‚‹",
    kamiRead: "ã‹ãœãã‚ˆã ãªã‚‰ã®ãŠãŒã‚ã® ã‚†ã†ãã‚Œã¯",
    shimoRead: "ã¿ããããªã¤ã® ã—ã‚‹ã—ãªã‚Šã‘ã‚‹",
  },
];

const GAME_QUESTIONS = 10;
const CHOICES = 4;

let currentSet = [];
let qIndex = 0;
let score = 0;
let locked = false;

let missedIds = new Set();   // é–“é•ãˆãŸæœ­ï¼ˆidï¼‰
let missedMap = new Map();   // id -> {kami, shimo}ï¼ˆä¸€è¦§è¡¨ç¤ºç”¨ï¼‰
let mode = "main";           // "main" or "review"

const $ = (id)=>document.getElementById(id);
const btnStart = $("btnStart");
const btnNextGame = $("btnNextGame");
const btnReview = $("btnReview");
const btnSpeak = $("btnSpeak");
const voiceStatus = $("voiceStatus");
const progress = $("progress");
const scoreBox = $("score");
const kamiBox = $("kami");
const choicesBox = $("choices");
const resultBox = $("result");
const missList = $("missList");
const effectLayer = $("effectLayer");

// ---------- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ----------
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function pickRandom(arr, n){
  return shuffle(arr).slice(0, n);
}
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

// ---------- éŸ³å£°èª­ã¿ä¸Šã’ï¼ˆWeb Speech APIï¼‰ ----------
function speechAvailable(){
  return 'speechSynthesis' in window && 'SpeechSynthesisUtterance' in window;
}

// â˜…èª­ã¿ä¸Šã’ãŒçµ‚ã‚ã‚‹ã¾ã§å¾…ã¦ã‚‹ç‰ˆ
function speakAsync(text){
  return new Promise((resolve) => {
    if(!speechAvailable()){
      resolve();
      return;
    }
    window.speechSynthesis.cancel();

    const u = new SpeechSynthesisUtterance(text);
    u.lang = "ja-JP";
    u.rate = 1.0;
    u.pitch = 1.0;
    u.volume = 1.0;

    u.onend = () => resolve();
    u.onerror = () => resolve(); // å¤±æ•—ã—ã¦ã‚‚æ­¢ã‚ãªã„

    window.speechSynthesis.speak(u);

    // å¿µã®ãŸã‚ï¼šonendãŒæ¥ãªã„ç«¯æœ«å¯¾ç­–ï¼ˆæœ€å¤§6ç§’ã§è§£é™¤ï¼‰
    setTimeout(() => resolve(), 6000);
  });
}

(function initVoice(){
  voiceStatus.textContent = speechAvailable() ? "éŸ³å£°ï¼šå¯¾å¿œï¼ˆç«¯æœ«ä¾å­˜ï¼‰" : "éŸ³å£°ï¼šéå¯¾å¿œ";
})();

// ===== å’Œé¢¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆåˆ¶å¾¡ =====
function showEffect(type){
  const count = 18; // ç²’ã®æ•°ï¼ˆå¤šã„ã»ã©æ´¾æ‰‹ï¼‰
  for(let i=0;i<count;i++){
    const el = document.createElement("div");
    el.className = `confetti ${type}`;
    el.style.left = (Math.random()*100) + "vw";
    el.style.top = "-20px";
    el.style.animationDelay = (Math.random()*120) + "ms";
    el.style.transform = `rotate(${Math.random()*180}deg)`;
    effectLayer.appendChild(el);
    setTimeout(()=> el.remove(), 1200);
  }
}

// ---------- ã‚²ãƒ¼ãƒ é–‹å§‹ ----------
function newMainGame(){
  mode = "main";
  missedIds = new Set();
  missedMap = new Map();

  currentSet = pickRandom(POEMS, GAME_QUESTIONS);
  qIndex = 0;
  score = 0;

  btnNextGame.disabled = true;
  btnReview.disabled = true;
  btnSpeak.disabled = false;

  renderQuestion();
}

function newReviewGame(){
  mode = "review";
  const missed = POEMS.filter(p => missedIds.has(p.id));

  if(missed.length === 0){
    kamiBox.textContent = "é–“é•ãˆãŸæœ­ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã™ã”ã„ï¼";
    choicesBox.innerHTML = "";
    resultBox.innerHTML = "";
    missList.innerHTML = "";
    btnReview.disabled = true;
    btnSpeak.disabled = true;
    return;
  }

  currentSet = pickRandom(missed, Math.min(GAME_QUESTIONS, missed.length));
  qIndex = 0;
  score = 0;

  btnNextGame.disabled = true;
  btnReview.disabled = true;
  btnSpeak.disabled = false;

  renderQuestion();
}

// ---------- å‡ºé¡Œ ----------
function renderQuestion(){
  locked = false;
  resultBox.innerHTML = "";
  missList.innerHTML = ""; // å‡ºé¡Œä¸­ã¯ä¸€è¦§ã‚’æ¶ˆã™

  if(qIndex >= currentSet.length){
    // çµ‚äº†ç”»é¢
    const total = currentSet.length;
    progress.textContent = (mode === "main") ? "ã‚²ãƒ¼ãƒ çµ‚äº†" : "å¾©ç¿’ çµ‚äº†";
    scoreBox.textContent = `ã‚¹ã‚³ã‚¢ï¼š${score} / ${total}`;

    if(mode === "main"){
      const missCount = missedIds.size;
      kamiBox.textContent = `ãŠã¤ã‹ã‚Œã•ã¾ã§ã—ãŸï¼ ${score} / ${total} æ­£è§£ï¼ˆé–“é•ã„ï¼š${missCount} é¦–ï¼‰`;
      choicesBox.innerHTML = "";
      btnNextGame.disabled = false;
      btnReview.disabled = (missCount === 0);
      btnSpeak.disabled = true;

      // â˜…é€šå¸¸ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã®ã¿ã€Œé–“é•ã„æœ­ä¸€è¦§ã€è¡¨ç¤º
      renderMissList();

    } else {
      const remaining = missedIds.size;
      kamiBox.textContent = `å¾©ç¿’ãŠã¤ã‹ã‚Œã•ã¾ã§ã—ãŸï¼ ${score} / ${total} æ­£è§£ï¼ˆã¾ã è‹¦æ‰‹ï¼š${remaining} é¦–ï¼‰`;
      choicesBox.innerHTML = "";
      btnNextGame.disabled = false;
      btnReview.disabled = (remaining === 0);
      btnSpeak.disabled = true;
      // å¾©ç¿’çµ‚äº†æ™‚ã¯ä¸€è¦§è¡¨ç¤ºã—ãªã„
    }
    return;
  }

  const q = currentSet[qIndex];

  progress.textContent = (mode === "main")
    ? `ç¬¬ ${qIndex+1} å• / ${currentSet.length}`
    : `å¾©ç¿’ ${qIndex+1} å• / ${currentSet.length}`;

  scoreBox.textContent = `ã‚¹ã‚³ã‚¢ï¼š${score} / ${qIndex}`;
  kamiBox.textContent = q.kami;

  // 4æŠï¼ˆæ­£è§£1 + ä¸æ­£è§£3ï¼‰
  const wrongPool = POEMS.filter(p => p.id !== q.id);
  const wrongs = pickRandom(wrongPool, CHOICES-1);
  const options = shuffle([q, ...wrongs]).map(p => ({
    id: p.id, text: p.shimo, correct: p.id === q.id
  }));

  choicesBox.innerHTML = options.map((o, idx)=>`
    <button class="choice" data-id="${o.id}" data-correct="${o.correct}">
      ${idx+1}. ${escapeHtml(o.text)}
    </button>
  `).join("");

  [...choicesBox.querySelectorAll("button.choice")].forEach(btn=>{
    btn.addEventListener("click", ()=>{
      if(locked) return;
      locked = true;

      const isCorrect = btn.dataset.correct === "true";

      // â˜…é–“é•ã„è¨˜éŒ²ï¼ˆé€šå¸¸ã‚²ãƒ¼ãƒ ï¼‰
      if(mode === "main"){
        if(!isCorrect){
          missedIds.add(q.id);
          missedMap.set(q.id, { kami: q.kami, shimo: q.shimo });
        }
      }

      // â˜…å¾©ç¿’ï¼šæ­£è§£ã—ãŸã‚‰è‹¦æ‰‹ã‹ã‚‰å¤–ã™ï¼ˆå®šç€ï¼‰
      if(mode === "review"){
        if(isCorrect) missedIds.delete(q.id);
        else missedIds.add(q.id);
      }

      if(isCorrect) score++;

      showResult(isCorrect, q.shimo);

      // â˜…æ¬¡ã«é€²ã‚€æ¡ä»¶ï¼š
      //  - æ­£è§£ï¼šå¾“æ¥é€šã‚Š 900ms å¾Œã«æ¬¡ã¸
      //  - ä¸æ­£è§£ï¼šä¸‹ã®å¥ã®èª­ã¿ä¸Šã’ãŒçµ‚ã‚ã£ã¦ã‹ã‚‰æ¬¡ã¸ï¼ˆèª­ã¿ä¸Šã’ãŒå‹•ã‹ãªã„ç«¯æœ«ã¯å³é€²è¡Œï¼‰
      const goNext = () => {
        if (speechAvailable()) window.speechSynthesis.cancel(); // èª­ã¿ä¸Šã’æ®‹ã‚Šé˜²æ­¢
        qIndex++;
        renderQuestion();
      };

      if(!isCorrect && speechAvailable()){
        setTimeout(async () => {
          await speakAsync(q.shimoRead || q.shimo); // â˜…èª­ã¿ä¸Šã’ç”¨ã‚’å„ªå…ˆ

          goNext();
        }, 200);
      } else {
        setTimeout(goNext, 900);
      }
    });
  });
}

// ---------- æ­£èª¤è¡¨ç¤ºï¼ˆâ€»èª­ã¿ä¸Šã’ã¯ã‚¯ãƒªãƒƒã‚¯å‡¦ç†å´ã§åˆ¶å¾¡ï¼‰ ----------
function showResult(isCorrect, correctText){
  const cls = isCorrect ? "ok" : "ng";
  const head = isCorrect ? "æ­£è§£ï¼" : "ã¡ãŒã†â€¦";
  resultBox.innerHTML = `
    <div class="result ${cls}">
      <strong>${head}</strong><br>
      æ­£ã—ã„ä¸‹ã®å¥ï¼š${escapeHtml(correctText)}
    </div>
  `;

  // â˜…ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç™ºå‹•
  showEffect(isCorrect ? "ok" : "ng");
}

// ---------- é–“é•ã„æœ­ä¸€è¦§ï¼ˆé€šå¸¸ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ï¼‰ ----------
function renderMissList(){
  const missed = [...missedMap.entries()].map(([id, v]) => ({ id, ...v }));

  if(missed.length === 0){
    missList.innerHTML = `<div class="result ok"><strong>å…¨å•æ­£è§£ï¼</strong> é–“é•ãˆãŸæœ­ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
    return;
  }

  const items = missed.map((m, i) => `
    <div style="background:#fff; border:1px solid #e7eaf4; border-radius:12px; padding:10px; margin-top:8px;">
      <div style="font-weight:800; margin-bottom:6px;">${i+1}.ï¼ˆé–“é•ã„ï¼‰</div>
      <div style="font-size:15px; line-height:1.5;"><strong>ä¸Šã®å¥ï¼š</strong>${escapeHtml(m.kami)}</div>
      <div style="font-size:15px; line-height:1.5; margin-top:4px;"><strong>ä¸‹ã®å¥ï¼š</strong>${escapeHtml(m.shimo)}</div>
    </div>
  `).join("");

  missList.innerHTML = `
    <div class="result ng">
      <strong>ä»Šå› é–“é•ãˆãŸæœ­ï¼ˆ${missed.length}é¦–ï¼‰</strong><br>
      ã€Œé–“é•ãˆãŸæœ­ã ã‘å¾©ç¿’ã€ã‚’æŠ¼ã™ã¨ã€ã“ã“ã‹ã‚‰å‡ºé¡Œã—ã¾ã™ã€‚
    </div>
    ${items}
  `;
}

// ---------- ãƒœã‚¿ãƒ³ ----------
btnStart.addEventListener("click", async ()=>{
  newMainGame();
  if(speechAvailable()){
    await speakAsync("ã¯ã˜ã‚ã¾ã™"); // åˆå›æ“ä½œã§éŸ³å£°ã‚’è¨±å¯ã•ã‚Œã‚„ã™ãã™ã‚‹
  }
});

btnNextGame.addEventListener("click", ()=>{
  newMainGame();
});

btnReview.addEventListener("click", ()=>{
  newReviewGame();
});

btnSpeak.addEventListener("click", ()=>{
  if(qIndex < currentSet.length){
    // ä¸Šã®å¥èª­ã¿ä¸Šã’ï¼ˆå¾…ãŸãªãã¦OKã ãŒã€é‡ãªã‚Šé˜²æ­¢ã§asyncç‰ˆï¼‰
    speakAsync(currentSet[qIndex].kamiRead || currentSet[qIndex].kami); // â˜…èª­ã¿ä¸Šã’ç”¨ã‚’å„ªå…ˆ

  }
});
</script>
</body>
</html>
